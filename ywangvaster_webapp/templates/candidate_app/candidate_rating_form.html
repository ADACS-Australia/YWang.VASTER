{% extends 'candidate_app/header.html' %}

{% block content %}

<!-- Aladin sky applet -->
<script type="text/javascript" src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8">
</script>

<style>
  #sidebar {
    position: fixed;
    right: -20vw;
    top: 12%;
    width: 30vw;
    height: 100vh;
    background-color: #f8f9fa;
    transition: right 0.3s ease;
  }

  #sidebar.sticky {
    right: 0.5vw;
  }

  #stickyButton {
    position: fixed;
    right: 0vw;
    top: 10%;
    transform: translateY(-50%);
    z-index: 1000;
  }

  #mainContent {
    transition: margin-right 0.3s ease;
    width: 100%;
    margin-left: 1.5vw;
  }

  #mainContent.expanded {
    margin-right: 20%;
  }
</style>

{% comment %} <button id="stickyButton" class="btn btn-primary">Toggle Sidebar</button> {% endcomment %}

<div id="sidebar" class="sticky p-3">

  <div class='card'>
    <div class='card-body'>
      <h4>Rate: {{candidate.name}} </h4>
      <form type='POST' action=''>
        {{ rate_form.as_table }}

        <button class='btn btn-primary' id='submit-rating' type='submit'>Rate!</button>
      </form>
    </div>
  </div>

</div>

<script>
  document.getElementById('stickyButton').addEventListener('click', function () {
    document.getElementById('sidebar').classList.toggle('sticky');
    document.getElementById('mainContent').classList.toggle('expanded');
  });
</script>

<div id="mainContent" class="expanded container mt-2">

  {% if candidate %}

  <!-- -->
  {{ lightcurve_data|json_script:"lightcurve_data" }}

  <div class="container-fluid">

    <!-- This the summary of the candidate -->
    <div class="row" style="padding: 2.5%">
      <div class='card'>
        <div class='card-body'>

          <!-- Row of download buttons for the candidate content -->
          <div class='hstack gap-2 flex-d justify-content-center align-items-center'>

            {% if candidate.slices_fits %}
            <div><a href=" {{ candidate.slices_fits.url }}"><button class='btn btn-primary'>SLICES FITS
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path
                      d="M11.292 16.706a1 1 0 0 0 1.416 0l3-3a1 1 0 0 0-1.414-1.414L13 13.586V4a1 1 0 0 0-2 0v9.586l-1.293-1.293a1 1 0 0 0-1.414 1.414zM17 19H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2z"
                      style="fill: #1c1b1e" />
                  </svg></button></a>
            </div>
            {% endif %}
            {% if candidate.deepcutout_fits %}
            <div><a href="{{ candidate.deepcutout_fits.url }}"><button class='btn btn-primary'>DEEPCUT
                  FITS
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path
                      d="M11.292 16.706a1 1 0 0 0 1.416 0l3-3a1 1 0 0 0-1.414-1.414L13 13.586V4a1 1 0 0 0-2 0v9.586l-1.293-1.293a1 1 0 0 0-1.414 1.414zM17 19H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2z"
                      style="fill: #1c1b1e" />
                  </svg></button></a>
            </div>
            {% endif %}
            {% if candidate.lightcurve_data %}
            <div>
              <a href="/download_lightcurve/{{ candidate.hash_id }}">
                <button class="btn btn-success">LIGHTCURVE CSV
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path
                      d="M11.292 16.706a1 1 0 0 0 1.416 0l3-3a1 1 0 0 0-1.414-1.414L13 13.586V4a1 1 0 0 0-2 0v9.586l-1.293-1.293a1 1 0 0 0-1.414 1.414zM17 19H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2z"
                      style="fill: #1c1b1e" />
                  </svg>
                </button>
              </a>
            </div>
            {% endif %}
          </div>

          <br />

          <div class='container-fluid'>
            <div class='row'>

              <!-- Column for data summary -->
              <div class='col'>

                <h3>Summary</h3>

                <!-- TODO: Make this better -->
                <div class='hstack gap-2'>
                  <text>Coordinates</text>
                  <text> RA: {{candidate.ra }} DEC: {{ candidate.dec_str }}
                </div>

                <br />

                <div class='vstack gap-5'>

                  Statistics
                  <table class='fl-table'>
                    <thead>
                      <th></th>
                      <th>Value</th>
                      <th>Sigma</th>
                      <th>Log Sigma</th>
                    </thead>

                    <tr>
                      <td>Chi^2</td>
                      <td>{{ candidate.chi_square|floatformat:3 }}</td>
                      <td>{{ candidate.chi_square_sigma|floatformat:3 }}</td>
                      <td>{{ candidate.chi_square_log_sigma|floatformat:3 }}</td>
                    </tr>
                    <tr>
                      <td>Peak map</td>
                      <td>{{ candidate.peak_map|floatformat:3}}</td>
                      <td>{{ candidate.peak_map_sigma|floatformat:3 }}</td>
                      <td>{{ candidate.peak_map_log_sigma|floatformat:3 }}</td>
                    </tr>
                    <tr>
                      <td>Gaussian map</td>
                      <td>{{ candidate.gaussian_map|floatformat:3}}</td>
                      <td>{{ candidate.gaussian_map_sigma|floatformat:3 }}</td>
                      <td>-</td>
                    </tr>
                    <tr>
                      <td>Standard map</td>
                      <td>{{ candidate.std_map|floatformat:3}}</td>
                      <td>-</td>
                      <td>-</td>
                    </tr>

                  </table>

                  Spatial Details
                  <table class='fl-table'>
                    <thead>
                      <th>
                      </th>
                      <th>Deep</th>
                      <th>Beam</th>
                      <th>Bright</th>
                    </thead>

                    <tr>
                      <td>Ra</td>
                      <td>{{ candidate.deep_ra_deg }}</td>
                      <td>{{ candidate.beam_ra }} </td>
                      <td> - </td>
                    </tr>
                    <tr>
                      <td>Dec</td>
                      <td>{{ candidate.deep_dec_deg }}</td>
                      <td>{{ candidate.beam_dec }} </td>
                      <td> - </td>
                    </tr>

                    <tr>
                      <td>Sep</td>
                      <td>{{ candidate.deep_sep_arcsec }}</td>
                      <td>{{ candidate.beam_sep_deg }} </td>
                      <td>{{ candidate.bright_sep_arcmin }}</td>
                    </tr>
                  </table>

                  Deep stats

                  <table class='fl-table'>
                    <thead>
                      <th>Name</th>
                      <th>Value</th>
                    </thead>

                    <tr>
                      <td>Deep name</td>
                      <td>{{ candidate.deep_name }}</td>
                    </tr>
                    <tr>
                      <td>Deep Num</td>
                      <td>{{ candidate.deep_num }}</td>
                    </tr>
                    <tr>
                      <td>Peak Flux</td>
                      <td>{{ candidate.deep_peak_flux|floatformat:3 }}</td>
                    </tr>
                    <tr>
                      <td>Int Flux</td>
                      <td>{{ candidate.deep_int_flux|floatformat:3 }}</td>
                    </tr>
                    <tr>
                      <td>MD Deep</td>
                      <td>{{ candidate.md_deep|floatformat:3 }}</td>
                    </tr>

                  </table>

                </div>
              </div>

              <!-- Column for images-->
              <div class='col'>
                <h3>Images</h3>

                <div class='flex-d justify-content-center align-items-center'>

                  {% if candidate.deepcutout_png %}
                  <h5>Deep</h5>
                  <img src="{{ candidate.deepcutout_png.url }}"
                    style="width: 100%; height: 100%; max-width: 600px; max-height: 600px;">
                  {% else %}
                  <div class='image-placeholder'
                    style="width: 100%; height: 300px; background: grey; border: 2px solid black;">
                    <p style="text-align: center; vertical-align: middle;">No deepcut image to display.</p>
                  </div>
                  {% endif %}


                  {% if candidate.slices_gif %}

                  <div class='vstack'>
                    <h5>Slices</h5>
                    <img src="{{ candidate.slices_gif.url }}"
                      style="width: 100%; height: 100%; max-width: 600px; max-height: 600px;">

                    {% comment %}

                    <canvas id="gifCanvas"></canvas>

                    <button onclick="playGif('gifCanvas')">Play</button>
                    <button onclick="pauseGif('gifCanvas')">Pause</button>
                    <button onclick="prevFrame('gifCanvas')">Previous Frame</button>
                    <button onclick="nextFrame('gifCanvas')">Next Frame</button>

                    {% endcomment %}

                    <div class='hstack gap-2'>
                      <button onclick="gifPrevFrame()">Prev Frame</button>
                      <button onclick="gifPuase()">Pause</button>
                      <button onclick="gifPlay()">Play</button>
                      <button onclick="gifnextFrame()">Next Frame</button>
                    </div>
                  </div>

                  {% else %}
                  <div class='image-placeholder'
                    style="width: 100%; height: 300px; background: grey; border: 2px solid black;">
                    <p style="text-align: center; vertical-align: middle;">No slices gif to display.</p>
                  </div>
                  {% endif %}

                </div>

              </div>
            </div>

            <hr />

            <!-- Javascript applets for candidate (ALADIN + ECHARTS) -->
            <div class='row'>

              <div class='col' style="width: 50%;">

                <div id="aladin-lite-div" style="height: 100%; width: 100%"></div>

              </div>

              <div class='col' style="width: 50%;">

                {% if lightcurve_data %}
                <div id="lightcurve_echarts" style="width: 100%; height: 600px; max-width: 900px"></div>
                {% else %}
                <div class='image-placeholder'
                  style="width: 100%; height: 600px; background: grey; border: 2px solid black;">
                  <p style="text-align: center; vertical-align: middle;">No lightcure data for ECharts to
                    render
                  </p>
                </div>
                {% endif %}

              </div>

            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- This is the summary of the beam that found the candidate-->
    <div class="row" style="padding: 2.5%">
      <h3>Nearby objects</h3>
      <div class='card'>
        <div class='card-body'>

          <div class="col-12 justify-content-center ">
            <p class="h5">Search nearby within
              <input id="arcmin" type="text" name="arcmin" value="{{arcmin_search}}" size="2">
              arcmin
              <button class="btn btn-primary" onclick="getAll()">Search</button>
            </p>
          </div>

          <div class='container-fluid'>
            <div class='row'>
              <div class='col' style="height: 500px; overflow-y: auto">
                <div id="simbadlocator">
                  <p>Loading ...</p>
                </div>
              </div>
              <div class='col' style="height: 500px; overflow-y: auto">
                <div id="pulsarlocator">
                  <p>Loading ... </p>
                </div>
              </div>
              <div class='col' style="height: 500px; overflow-y: auto">
                <div id="nearestlocator">
                  <p>Loading ... </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- This is the summary of the beam that found the candidate-->
    <div class="row" style="padding: 2.5%">
      <h3>Statistical Maps</h3>
      <div class='card' style="padding: 2.5%">
        <div class='card-body'>

          <div class='hstack gap-3 flex-d justify-content-center'>
            {% if candidate.beam.std_fits %}
            <div>
              <a href="{{ candidate.beam.std_fits.url }}"><button class='btn btn-primary'>STD
                  FITS
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path
                      d="M11.292 16.706a1 1 0 0 0 1.416 0l3-3a1 1 0 0 0-1.414-1.414L13 13.586V4a1 1 0 0 0-2 0v9.586l-1.293-1.293a1 1 0 0 0-1.414 1.414zM17 19H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2z"
                      style="fill: #1c1b1e" />
                  </svg>
                </button>
              </a>
            </div>
            {% endif %}
            {% if candidate.beam.peak_fits.url %}
            <div>
              <a href="{{ candidate.beam.peak_fits.url }}"><button class='btn btn-primary'>PEAK
                  FITS
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path
                      d="M11.292 16.706a1 1 0 0 0 1.416 0l3-3a1 1 0 0 0-1.414-1.414L13 13.586V4a1 1 0 0 0-2 0v9.586l-1.293-1.293a1 1 0 0 0-1.414 1.414zM17 19H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2z"
                      style="fill: #1c1b1e" />
                  </svg>
                </button>
              </a>
            </div>
            {% endif %}
            {% if candidate.beam.chisquare_fits.url %}
            <div>
              <a href="{{ candidate.beam.chisquare_fits.url }}"><button class='btn btn-primary'>CHISQUARE
                  FITS
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path
                      d="M11.292 16.706a1 1 0 0 0 1.416 0l3-3a1 1 0 0 0-1.414-1.414L13 13.586V4a1 1 0 0 0-2 0v9.586l-1.293-1.293a1 1 0 0 0-1.414 1.414zM17 19H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2z"
                      style="fill: #1c1b1e" />
                  </svg>
                </button>
              </a>
            </div>
            {% endif %}
          </div>

          <br />

          <div class='container-fluid'>
            <div class='row'>
              <div class='col-lg'>
                {% if candidate.beam.chisquare_map1_png %}
                Chi square map 1
                <img src="{{ candidate.beam.chisquare_map1_png.url}}"
                  style="width: 100%; height: 100%; object-fit: contain;">
                {% endif %}
              </div>

              <div class='col-lg'>
                {% if candidate.beam.chisquare_map2_png %}
                Chi square map 2
                <img src="{{ candidate.beam.chisquare_map2_png.url }}"
                  style="width: 100%; height: 100%; object-fit: contain;">
                {% endif %}
              </div>
            </div>
            <div class='row'>
              <div class='col-lg'>
                {% if candidate.beam.peak_map1_png %}
                Peak map 1
                <img src="{{ candidate.beam.peak_map1_png.url }}"
                  style="width: 100%; height: 100%;object-fit: contain;">
                {% endif %}
              </div>
              <div class='col-lg'>
                {% if candidate.beam.peak_map2_png %}
                Peak map 2
                <img src="{{ candidate.beam.peak_map2_png.url }}"
                  style="width: 100%; height: 100%; object-fit: contain;">
                {% endif %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

</div>


{% else %}
<p>Candidate not Found!</p>
{% endif %}


<script>
  // Echarts for plotting the lightcurve data

  let lightcurve_data = JSON.parse(document.getElementById("lightcurve_data").textContent);
  let lightcurveChart = echarts.init(document.getElementById("lightcurve_echarts"), null);

  // Calculate the min and max values for the y-axis
  let values = lightcurve_data.map(function (item) {
    return item[1];
  });

  // Remove title  min/max find
  values.shift();
  let minValue = 0.95 * Math.min(...values);
  let maxValue = 1.05 * Math.max(...values);

  // Function to render the error bars
  function renderErrorBar(params, api) {
    const xValue = api.value(0);
    const yValue = api.value(1);
    const err = parseFloat(api.value(2)); // Not sure parse to float is needed.

    const highPoint = api.coord([xValue, yValue + err]);
    const lowPoint = api.coord([xValue, yValue - err]);

    const style = api.style({
      stroke: '#5470C6',
      fill: null,
    });

    return {
      type: 'group',
      children: [{
        type: 'line',
        shape: {
          x1: highPoint[0],
          y1: highPoint[1],
          x2: lowPoint[0],
          y2: lowPoint[1]
        },
        style: style
      }]
    };
  }


  let option = {
    tooltip: {
      trigger: 'item',

    },
    animation: false,
    dataZoom: [{
      type: 'slider',
      xAxisIndex: [0],
      filterMode: 'filter',
      // height: 12,
      //bottom: 20,
    }, ],
    title: {
      text: 'Lightcurve Peak Flux',
      position: "center"
    },
    tooltip: {
      trigger: 'axis'
    },
    xAxis: {
      type: 'time',
      datazoom: true,
      name: 'Time (UTC)',
      nameLocation: 'middle',
      nameGap: 22
    },
    yAxis: {
      type: 'value',
      min: minValue,
      max: maxValue,
      axisLabel: {
        formatter: function (value) {
          return value.toFixed(1);
        },
        minInterval: 1,
      },
      name: 'Peak Flux Density (mJy/beam)',
      nameLocation: 'middle',
      nameGap: 50
    },
    series: [{
        data: lightcurve_data,
        dimensions: ["Time", "{{candidate.name}}", "Error bars"],
        encode: {
          x: 0,
          y: 1,
          tooltip: 1,
        },
        type: 'line',
        smooth: false,
        lineStyle: {
          color: '#5470C6'
        }
      },
      {
        type: 'custom',
        name: 'error',
        renderItem: (params, api) => renderErrorBar(params, api),
        dimensions: ["Time", "{{candidate.name}}", "Error bars"],
        encode: {
          x: 0,
          y: 1,
          tooltip: 2,
        },
        data: lightcurve_data,
        z: 100
      },
    ],
    tooltip: {
      show: true,
      trigger: "axis"
    },
  };

  // Set the options to the chart
  lightcurveChart.setOption(option);

  // Add event listener for window resize
  window.addEventListener("resize", () => {
    lightcurveChart.resize();
  });
</script>

<!-- Scripts for finding objects relative to candidates -->
<script>
  async function getSimbad() {
    try {
      let simbadDiv = document.getElementById('simbadlocator');
      let arcmin = document.getElementById('arcmin').value

      console.log(`Simbad - searching within ${arcmin} arcmin of {{candidate.ra_str}} {{candidate.dec_str}}`);

      simbadDiv.innerHTML = "<p>Loading SIMBAD search data ...</p>";

      const response = await fetch('/cone_search_simbad/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{csrf_token }}',
        },
        body: JSON.stringify({
          ra_str: '{{ candidate.ra_str }}',
          dec_str: '{{ candidate.dec_str }}',
          dist_arcmin: arcmin
        })
      });
      const data = await response.text();
      console.log("simbad got success!");
      simbadDiv.innerHTML = data;
    } catch (error) {
      console.log(error);
    }
  }

  async function getNearest() {
    try {
      let nearestDiv = document.getElementById('nearestlocator');
      let arcmin = document.getElementById('arcmin').value

      console.log(nearestDiv);
      console.log(
        `Nearest in DB - Searching within ${arcmin} arcmin of {{candidate.ra_str}} {{candidate.dec_str}}`);

      nearestDiv.innerHTML = "<p>Finding nearby candiates ...</p>";

      const response = await fetch('/cone_search/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{csrf_token }}'
        },
        body: JSON.stringify({
          ra_str: '{{ candidate.ra_str }}',
          dec_str: '{{ candidate.dec_str }}',
          dist_arcmin: arcmin,
          exclude_id: '{{ candidate.hash_id }}',
          project: '{{ candidate.project_id }}'
        })
      });

      const data = await response.text();
      nearestDiv.innerHTML = data;
      console.log("Successfully got nearest candidates from project: {{ candidate.project_id }}")
    } catch (error) {
      console.log(error);
    }
  }

  async function getPulsars() {
    try {
      let pulsarDiv = document.getElementById('pulsarlocator');
      let arcmin = document.getElementById('arcmin').value

      console.log(pulsarDiv);
      console.log(`Searching within ${arcmin} arcmin of {{candidate.ra_str}} {{candidate.dec_str}}`);

      pulsarDiv.innerHTML = "<p>Finding nearby candiates ...</p>";

      const response = await fetch('/cone_search_pulsars/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{csrf_token }}'
        },
        body: JSON.stringify({
          ra_str: '{{ candidate.ra_str }}',
          dec_str: '{{ candidate.dec_str }}',
          dist_arcmin: arcmin,
        })
      });
      const data = await response.text();
      // console.log(data);
      pulsarDiv.innerHTML = data;
    } catch (error) {
      console.log(error);
    }
  }
  async function getAll() {
    try {
      getSimbad();
      getNearest();
      //getPulsars();
    } catch (error) {
      console.log(error);
    }
  }
  document.addEventListener('DOMContentLoaded', getAll)
</script>


<!-- Load the Aladin applet on the page looking at the coords of the candidate -->
<script type="text/javascript">
  let aladin;
  A.init.then(() => {
    aladin = A.aladin('#aladin-lite-div', {
      survey: "P/DSS2/color",
      fov: "{{candidate.deep_sep_arcsec|floatformat:2}}", // 1, // degress of field of view
      target: "{{candidate.name}}",
    });
  });
</script>

{% endblock %}